<!DOCTYPE html>
<html>
  <head>
    <title>下拉選單示例</title>
    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

	<style>
		.but 
		{
			background-color: #dd0ca2;
			border: none;
            border-radius: 5px;
			color: white;
			padding: 15px 32px;
			text-align: center;
			text-decoration: none;
			display: inline-block;
			font-size: 16px;
			margin: 10px 20px;
			cursor: pointer;
		}
	</style>

  </head>
  <body>
    <h1>下拉選單示例</h1>
    <label for="options">選擇一個選項：</label>
    <select id="options" onchange="showItems()">
      <option value="">請選擇頁數</option>
      <option value="option1">P10~19</option>
      <option value="option2">P20~29</option>
      <option value="option3">P30~39</option>
      <option value="option4">P40~49</option>
      <option value="option5">P50~59</option>
      <option value="option6">P60~69</option>
      <option value="option7">P70~79</option>
      <option value="option8">P80~89</option>
      <option value="option9">P90~99</option>
      <option value="option10">P100~109</option>
      <option value="option11">P110~119</option>
      <option value="option12">P120~129</option>
      <option value="option13">P130~139</option>
      <option value="option14">P140~149</option>
      <option value="option15">P150~159</option>
      <option value="option16">P160~169</option>
      <option value="option17">P170~172</option>
      <option value="option18">ALL</option>

    </select>
        <div style="margin-top:12px;">
            <input type="file" id="mdUpload" accept=".md" onchange="handleMdUpload(event)">
            <span id="mdStatus" style="margin-left:8px;color:#555;"></span>
        </div>
    <form id="itemList">
        
    </form>
    <button class="but" type="button" onclick="submitForm()">Submit</button>
    
    <script>

        let aaaa = ["1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","1","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","2","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","3","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","4","5","5","5","5","5","5","5","5","5","5","5","5","5","5","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","6","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","7","8","8","8","8","8","8","8","8","8","8","8","8","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","9","10","10","10","10","10","10","10","10"];
        let bbbbb = ["0","1","2","3","4","5","6","7","8","9","10","11","12","15","16","18","19","20","21","22","24","25","26","27","28","29","30","31","32","33","34","35","36","50","51","56","59","60","62","68","69","70","72","73","77","79","80","81","83","86","90","94","97","99","1","3","8","9","10","11","12","16","17","18","20","23","24","32","34","36","37","38","39","41","42","46","48","50","51","55","56","57","75","85","88","90","95","98","99","1","3","4","5","8","9","10","11","12","13","14","15","17","18","19","20","24","26","27","28","29","31","32","33","34","38","40","43","46","47","49","50","54","56","57","60","61","62","63","64","67","69","71","72","80","90","91","92","93","95","96","97","99","2","6","7","10","24","25","26","27","29","30","31","34","39","41","43","45","46","49","53","56","57","58","59","60","61","62","68","69","70","71","78","82","84","85","87","90","92","93","99","0","7","14","22","23","24","41","45","47","48","50","55","56","57","58","59","66","67","82","84","86","87","88","90","92","94","97","0","4","5","6","8","10","13","17","18","20","22","25","30","34","41","42","43","44","46","47","54","57","65","70","71","72","73","75","78","87","88","91","92","93","97","98","99","0","2","4","6","10","13","14","15","16","18","20","24","25","27","28","38","39","40","43","47","48","50","52","53","55","56","58","59","61","67","69","71","78","82","87","92","94","99","4","7","10","12","16","21","22","23","24","28","29","30","31","32","33","34","36","38","47","56","59","60","64","69","70","72","73","77","79","80","82","83","84","85","86","88","89","97","99","1","2","3","5","6","8","10","16","18","21","27","28","29","31","38","40","42","45","61","62","67","71","72","73","75","76","77","78","80","81","84","90","92","95","99","6","7","12","13","14","16","19","21"];
        console.log(aaaa.length);
        console.log(bbbbb.length);

        function showItems() {
            var selectBox = document.getElementById("options");
            var selectedValue = selectBox.options[selectBox.selectedIndex].value;
            var itemList = document.getElementById("itemList");

            // 清空項目列表
            itemList.innerHTML = "";
            checkboxKeys.clear();

            // 根據選項值，顯示對應的項目
            switch (selectedValue) {
                case "option1":
                    creatQuestion(10, 19);
                    break;

                case "option2":
                    creatQuestion(20, 29);
                    break;

                case "option3":
                    creatQuestion(30, 39);
                    break;

                case "option4":
                    creatQuestion(40, 49);
                    break;

                case "option5":
                    creatQuestion(50, 59);
                    break;

                case "option6":
                    creatQuestion(60, 69);
                    break;

                case "option7":
                    creatQuestion(70, 79);
                    break;

                case "option8":
                    creatQuestion(80, 89);
                    break;

                case "option9":
                    creatQuestion(90, 99);
                    break;

                case "option10":
                    creatQuestion(100, 109);
                    break;

                case "option11":
                    creatQuestion(110, 119);
                    break;

                case "option12":
                    creatQuestion(120, 129);
                    break;

                case "option13":
                    creatQuestion(130, 139);
                    break;

                case "option14":
                    creatQuestion(140, 149);
                    break;

                case "option15":
                    creatQuestion(150, 159);
                    break;

                case "option16":
                    creatQuestion(160, 169);
                    break;

                case "option17":
                    creatQuestion(170, 172);
                    break;
                case "option18":
                    creatQuestion(1, 10);
                    break;

            }
        }

    const checkboxKeys = new Set();
    let qaDataPromise = null;
    let qaData = [];

    async function loadQAData() {
        if (qaDataPromise) return qaDataPromise;
        qaDataPromise = fetch("../QA_new.json").then((res) => res.json()).then((data) => {
            qaData = data;
            return qaData;
        }).catch((err) => {
            console.error("載入 QA 資料失敗", err);
            return [];
        });
        return qaDataPromise;
    }

    async function creatQuestion(sp,ep) {
        const data = await loadQAData();
        for (let i = sp; i <= ep; i++) {
            const pageData = data[i - 1];
            if (!pageData || !Array.isArray(pageData.question)) continue;
            const k = pageData.question.length;
            for(let j = 0; j < k; j++) {
                checkbox_creat(pageData.page || i, pageData.question[j], j);
            }
        }
    }

        function checkbox_creat(p, Q, q_n)
        {

            const container = document.getElementById("itemList");
            const id = `ck-${p}-${q_n}`;
            if (checkboxKeys.has(id)) return;
            checkboxKeys.add(id);

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.name = "option";
            checkbox.value = p;
            checkbox.id = id;
            checkbox.dataset.page = p;
            checkbox.dataset.index = q_n;
            checkbox.dataset.question = Q;
                
            const label = document.createElement("label");
            label.style = "font-size:30px";
            label.setAttribute("name", q_n);
            label.setAttribute("for", id);
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(`第${p}頁：${Q}`));

            container.appendChild(label);
            container.appendChild(document.createElement("br"));
         
        }

        function normalizeText(str) {
            // 轉小寫，移除標點符號但保留空格用於詞彙分割
            return (str || "").toLowerCase()
                .replace(/[.,，。！？?、；;:："""'()（）【】\[\]\-\d]/g, " ")
                .replace(/\s+/g, " ")
                .trim();
        }

        function getTokens(str) {
            // 提取詞彙（以空格為分隔符）
            const normalized = normalizeText(str);
            return normalized.split(/\s+/).filter((t) => t.length > 0);
        }

        function isFuzzyMatch(a, b) {
            const tokensA = getTokens(a);
            const tokensB = getTokens(b);
            
            if (!tokensA.length || !tokensB.length) return false;
            
            // 詞彙重疊度檢查（15% 閾值）
            const setB = new Set(tokensB);
            let overlap = 0;
            for (const t of tokensA) {
                if (setB.has(t)) overlap += 1;
            }
            const denom = Math.max(tokensA.length, tokensB.length);
            return overlap / denom >= 0.50
        }

        function extractQuestionsFromMarkdown(text) {
            const lines = text.split(/\r?\n/).map((l) => l.trim()).filter(Boolean);
            const qs = [];
            for (const line of lines) {
                const cleaned = line.replace(/^[#>*\-\d\.)\s]+/, "").trim();
                if (!cleaned) continue;
                if (/[?？]/.test(cleaned) || cleaned.length > 6) {
                    qs.push(cleaned);
                }
            }
            return Array.from(new Set(qs));
        }

        function updateMdStatus(message) {
            const el = document.getElementById("mdStatus");
            if (el) el.textContent = message;
        }

        async function handleMdUpload(event) {
            const file = event.target.files && event.target.files[0];
            if (!file) return;
            updateMdStatus("讀取檔案中...");
            try {
                const text = await file.text();
                const mdQuestions = extractQuestionsFromMarkdown(text);
                if (!mdQuestions.length) {
                    updateMdStatus("未在檔案中找到題目");
                    return;
                }
                const data = await loadQAData();
                let matchCount = 0;
                const matchedMd = new Set();
                for (let pIdx = 0; pIdx < data.length; pIdx++) {
                    const pageData = data[pIdx];
                    if (!pageData || !Array.isArray(pageData.question)) continue;
                    for (let qIdx = 0; qIdx < pageData.question.length; qIdx++) {
                        const qaQuestion = pageData.question[qIdx];
                        for (const mdQ of mdQuestions) {
                            if (isFuzzyMatch(mdQ, qaQuestion)) {
                                ensureCheckboxChecked(pageData.page || (pIdx + 1), qaQuestion, qIdx);
                                matchCount += 1;
                                matchedMd.add(mdQ);
                                break;
                            }
                        }
                    }
                }
                const unmatched = mdQuestions.filter((q) => !matchedMd.has(q));
                if (unmatched.length) {
                    console.log("未匹配到的題目:", unmatched);
                } else {
                    console.log("所有上傳的題目皆已匹配到");
                }
                updateMdStatus(`匹配並勾選了 ${matchCount} 題，未匹配 ${unmatched.length} 題`);
            } catch (err) {
                console.error(err);
                updateMdStatus("解析檔案時發生錯誤");
            }
        }

        function ensureCheckboxChecked(pageLabel, questionText, questionIndex) {
            const id = `ck-${pageLabel}-${questionIndex}`;
            let checkbox = document.getElementById(id);
            if (!checkbox) {
                checkbox_creat(pageLabel, questionText, questionIndex);
                checkbox = document.getElementById(id);
            }
            if (checkbox) {
                checkbox.checked = true;
            }
        }

        const selectedOptions = []; //儲存頁數
        const questionNumber = []; //儲存題號
        function submitForm() {
			const form = document.forms[0];

			for (let i = 0; i < form.option.length; i++) {
				if (form.option[i].checked) {
					selectedOptions.push(form.option[i].value);
                    let q_n = form.option[i].parentNode.getAttribute('name');
                    questionNumber.push(q_n);
				}
			}

			console.log(selectedOptions);
            console.log(questionNumber);
		}


    </script>
